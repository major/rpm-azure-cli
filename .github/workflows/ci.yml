name: RPM CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  package:
    name: "ðŸ“¦"
    runs-on: ubuntu-20.04
    container:
      image: quay.io/major/fedora-packager
      options: "--privileged"
    steps:

      - name: Checkout
        uses: actions/checkout@v2.3.4

      - name: Cache multiple paths
        uses: actions/cache@v2
        with:
          path: |
            ~/rpmbuild/SOURCES
          key: ${{ runner.os }}-${{ hashFiles('specs/*') }}

      - name: Build source RPMs
        run: |
          cd specs
          for SPEC in $(ls *.spec); do
            rpmdev-spectool -R -g $SPEC
          done
          rpmbuild -bs *.spec

      - name: Mock build
        run: |
          mock -r /etc/mock/fedora-rawhide-x86_64.cfg \
            --postinstall $(ls ~/rpmbuild/SRPMS/*.src.rpm)
